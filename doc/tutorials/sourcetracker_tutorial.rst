.. _SourceTracker:

===========================
SourceTracker
===========================

Introduction
------------
This tutorial explains how to use the SourceTracker software. SourceTracker is a software package designed to predict the relationship between microbial communities. These are 'Source' and 'Sink' 

Please note that this tutorial does not attempt to cover every possible usage of Source Tracker. Instead, it attempts to provide useful examples to give you an idea of how to use these statistical methods in your own analysis.

Input Files
-----------
You can obtain the files used in this tutorial `here <https://www.dropbox.com/s/f4yikgac95ivkru/sourcetracker_tutorial_files.zip?m>`_. The files are taken from a study (Hewitt et al., 2013) Where samples were collected from three different NICUS, from various surfaces. These samples were sequenced and then analyzed against existing data sets using SourceTracker in order to predict the likely origin of the microbial communities of each specific NICU sample.

Output Files
------------
The output file generated by this script will vary. They will all be placed in the directory specified by the required -o option. The files generated by this script contain charts and graphs and are in the pdf format. These can be viewed with a web browser or any other image viewing software.

Test Usage
----------
Before running SourceTracker it may be useful to check that it that all of the dependencies as well as SourceTracker are correctly installed.

To check that it is running properly, run the following command: ::

    R --slave --vanilla --args -h < sourcetracker_for_qiime.r

This command runs the 'help' command and returns a list of all of the options available to the terminal. The first few lines of the return are shown below. 

.. note::

    * -i otu table: QIIME-formatted OTU table (first line is a comment line starting with '#', second line starts with '#OTU ID' followed by sample names). You must supply either this or the taxon table via '-t'.
    * -t taxon table: output from QIIME script summarize_taxa.py. You must supply either this or the otu table via '-i'.
    * -m mapfile: mapping file with an 'Env' column giving the source environments, and a 'SourceSink' column giving 'source' for source samples and 'sink' for sink samples.
    * -n number of restarts of Gibbs sampling (default 10)
    * -b number of burn-in iterations for Gibbs sampling (default 100)

Filter otu table by 1%
---------------------
PERHAPS SOME HELP HERE ON WHY WE DO THIS?. Before the rest of the analysis is run the OTU table needs to be filtered by one percent. The number of samples in the OTU table can be obtained by running per_library_stats.py on the OTU table.
To filter the OTU table Run the following command: ::

    filter_otus_from_otu_table.py -i otu_table.biom -o filtered_otu_table.biom -s 7

This command will create an output file named :file:`filtered_otu_table.biom`, this is s new otu table that has been sampled to 1% the input to the -s command should be 1 percent of the samples in the original OTU table.

Rarefy to 100 sequences
-----------------------
This command will rarefy the sequences to a depth of 100. 
To rarefy the sequences run the following command: ::
    single_rarefaction.py -i filtered_otu_table.biom  -o filtered_otu_table_100.biom -d 100
    
This command creates a new otu table named :file:`filtered_otu_table_100.biom` with the sequences rarefied to a depth of 100.

Convert table from .biom to .txt
--------------------------------
SourceTracker does not work with the biom format. In order to run SourceTracker the OTU table needs to be converted to .txt.
To convert the OTU table to text format run the following command: ::

    convert_biom.py -i filtered_otu_table_100.biom -o filtered_otu_table_100.txt -b

This creates a file named :file:`filtered_otu_table_100.txt` which is the OTU table in text format. 

Run SourceTracker
-----------------

When running SourceTracker it is important to note that a column titled 'SourceSink' is required and the categories in this column must be 'source', 'sink', or 'NA'. A column titled 'ENV' is also required the categories in this column are the names that are related to source an sink. us 'NA' for samples to not be included.

In order to run SourceTracker run the following command: ::

    R --slave --vanilla --args -i filtered_otu_table_100.txt -m map.txt -o sourcetracker_out < sourcetracker_for_qiime.r



Open up :file:`sink_predictions_pie_NICU BabyBedside.pdf` to view an example of the output:

.. image:: ../images/sink_predictions_pie_NICU_BabyBedside.png
   :align: center

These pie charts represent the likely origin of microbial communities from each sample taken from the BabyBedside. Each of the colors in the bar chart represent one of the sources that were denoted in the mapping file. The precent of the chart for each source is relative to how similar the sample is to that source. 

References
----------

Knights, Dan et al. "Bayesian community-wide culture-independent microbial source tracking." Nature Methods(2011)761-763 SHOULD I USE THE DOI HERE? OR SOMETHING ELSE?

Hewitt, Krissi M et al. "Bacterial Diversity in Two Neonatal Intensive Care Units (NICUs)." PLOS ONE (2013)